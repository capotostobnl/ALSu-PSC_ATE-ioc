##########################################
# PSC Tester unified DB (Tester + Tester2)
# Original PV names, now backed by asyn
# Requires macros: P, PORT
##########################################

# --- IP settings (display only; driver IP is from st.cmd) ---
record(stringout,"$(P)IP:Settings-SP"){
  field(DESC,"IP Address:Port #")
  field(DTYP,"Soft Channel")
  field(PINI,"YES")
  field(VAL,"$(IPPORT)")
}


# =======================================
# Control records -> asyn driver
# =======================================

# --- CAL state ---
record(bo, "$(P)CAL:State-SP") {
    field(DESC, "Set CAL OFF or ON")
    field(ZNAM,"OFF")
    field(ONAM,"ON")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CAL_STATE")
    field(VAL,"0")       # CAL OFF
    field(PINI,"YES")    # Initialize at boot
}

record(bo, "$(P)CH1:Mode-SP") {
    field(DESC, "Set CH1 Mode to TEST or CAL")
    field(ZNAM,"TEST")
    field(ONAM,"CAL")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH1_MODE")
    field(VAL,"0")       # TEST
    field(PINI,"YES")
}

record(bo, "$(P)CH2:Mode-SP") {
    field(DESC, "Set CH2 Mode to TEST or CAL")
    field(ZNAM,"TEST")
    field(ONAM,"CAL")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH2_MODE")
    field(VAL,"0")       # TEST
    field(PINI,"YES")
}

record(bo, "$(P)CH3:Mode-SP") {
    field(DESC, "Set CH3 Mode to TEST or CAL")
    field(ZNAM,"TEST")
    field(ONAM,"CAL")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH3_MODE")
    field(VAL,"0")       # TEST
    field(PINI,"YES")
}

record(bo, "$(P)CH4:Mode-SP") {
    field(DESC, "Set CH4 mode to TEST or CAL")
    field(ZNAM,"TEST")
    field(ONAM,"CAL")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH4_MODE")
    field(VAL,"0")       # TEST
    field(PINI,"YES")
}

record(bo, "$(P)Polarity-SP") {
    field(DESC, "Set Polarity")
    field(ZNAM, "BPC")
    field(ONAM, "UPC")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) POLARITY")
    field(VAL,"0")       # BPC
    field(PINI,"YES")
}


# --- DCCT fault select ---
record(mbbo, "$(P)DCCT:Fault:Channel-SP") {
    field(DESC, "Select DCCT Fault Channel")
    field(ZRST,"NONE")
    field(ONST,"CH1")
    field(TWST,"CH2")
    field(THST,"CH3")
    field(FRST,"CH4")
    field(ZRVL,"0")
    field(ONVL,"1")
    field(TWVL,"2")
    field(THVL,"3")
    field(FRVL,"4")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) DCCT_FAULT_CH")
    field(VAL,"0")       # NONE
    field(PINI,"YES")
}

# --- Ignd channel selection ---
record(mbbo, "$(P)Ignd:Channel-SP") {
    field(DESC, "Select Ignd Channel")
    field(ZRST,"CH1")
    field(ONST,"CH2")
    field(TWST,"CH3")
    field(THST,"CH4")
    field(ZRVL,"1")
    field(ONVL,"2")
    field(TWVL,"3")
    field(THVL,"4")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) IGND_CH")
    field(VAL,"0")       # CH1 (since ZRVL=1)
    field(PINI,"YES")
}


# --- DI bits per channel (Tester2 DI11..DI43) ---
record(bo, "$(P)CH1:FLT1-SP") {
    field(DESC, "Set CH1 FLT1 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH1_FLT1")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH1:FLT2-SP") {
    field(DESC, "Set CH1 FLT2 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH1_FLT2")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH1:Spare-SP") {
    field(DESC, "Set CH1 Spare State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH1_SPARE")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH2:FLT1-SP") {
    field(DESC, "Set CH2 FLT1 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH2_FLT1")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH2:FLT2-SP") {
    field(DESC, "Set CH2 FLT2 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH2_FLT2")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH2:Spare-SP") {
    field(DESC, "Set CH2 Spare State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH2_SPARE")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH3:FLT1-SP") {
    field(DESC, "Set CH3 FLT1 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH3_FLT1")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH3:FLT2-SP") {
    field(DESC, "Set CH3 FLT2 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH3_FLT2")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH3:Spare-SP") {
    field(DESC, "Set CH3 Spare State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH3_SPARE")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH4:FLT1-SP") {
    field(DESC, "Set CH4 FLT1 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH4_FLT1")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH4:FLT2-SP") {
    field(DESC, "Set CH4 FLT2 State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH4_FLT2")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH4:Spare-SP") {
    field(DESC, "Set CH4 Spare State")
    field(ZNAM, "Low")
    field(ONAM, "High")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) CH4_SPARE")
    field(VAL,"0")
    field(PINI,"YES")
}

# --- Vmon gains ---
record(ao,"$(P)CH1:Vmon:Gain-SP"){
  field(DESC,"CH1 Vmon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) VGAIN1")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH2:Vmon:Gain-SP"){
  field(DESC,"CH2 Vmon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) VGAIN2")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH3:Vmon:Gain-SP"){
  field(DESC,"CH3 Vmon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) VGAIN3")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH4:Vmon:Gain-SP"){
  field(DESC,"CH4 Vmon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) VGAIN4")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

# --- Imon gains ---

record(ao,"$(P)CH1:Imon:Gain-SP"){
  field(DESC,"CH1 Imon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) IGAIN1")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH2:Imon:Gain-SP"){
  field(DESC,"CH2 Imon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) IGAIN2")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH3:Imon:Gain-SP"){
  field(DESC,"CH3 Imon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) IGAIN3")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}

record(ao,"$(P)CH4:Imon:Gain-SP"){
  field(DESC,"CH4 Imon Gain")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) IGAIN4")
  field(PREC,"3")
  field(VAL,"0")
  field(PINI,"YES")
}


# --- CALDAC ---
record(ao,"$(P)CAL:DAC-SP"){
  field(DESC,"Calibration DAC")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) CALDAC")
  field(PREC,"6")
  field(VAL,"0")
  field(PINI,"YES")
}

# --- Ignd value ---
record(ao,"$(P)Ignd-SP"){
  field(DESC,"Ignd value")
  field(DTYP,"asynFloat64")
  field(OUT,"@asyn($(PORT),0) IGND")
  field(PREC,"3")
  field(VAL,"0")         # Ignd = 0.0
  field(PINI,"YES")
}

# =======================================
# Readbacks from driver
# =======================================
# --- D15? readback currents ---
record(ai,"$(P)DCCT:P15V:14-I"){
  field(DESC,"+15V CH14 current")
  field(DTYP,"asynFloat64")
  field(INP,"@asyn($(PORT),0) P15V_14")
  field(PREC,"3")
  field(SCAN,"I/O Intr")
  field(PINI,"YES")
}

record(ai,"$(P)DCCT:N15V:14-I"){
  field(DESC,"-15V CH14 current")
  field(DTYP,"asynFloat64")
  field(INP,"@asyn($(PORT),0) N15V_14")
  field(PREC,"3")
  field(SCAN,"I/O Intr")
  field(PINI,"YES")
}

record(ai,"$(P)DCCT:P15V:58-I"){
  field(DESC,"+15V CH58 current")
  field(DTYP,"asynFloat64")
  field(INP,"@asyn($(PORT),0) P15V_58")
  field(PREC,"3")
  field(SCAN,"I/O Intr")
  field(PINI,"YES")
}

record(ai,"$(P)DCCT:N15V:58-I"){
  field(DESC,"-15V CH58 current")
  field(DTYP,"asynFloat64")
  field(INP,"@asyn($(PORT),0) N15V_58")
  field(PREC,"3")
  field(SCAN,"I/O Intr")
  field(PINI,"YES")
}

# --- Status (D15? OK/Fail) ---
record(longin,"$(P)Readback:Status-I"){
  field(DESC,"D15? readback status")
  field(DTYP,"asynInt32")
  field(INP,"@asyn($(PORT),0) STATUS")
  field(SCAN,"I/O Intr")
  field(PINI,"YES")
}


# =======================================
# Manual UDP command and PC faults
# =======================================

# --- Manual command: free-form UDP ---
record(stringout, "$(P)MAN-CMD-SP") {
  field(DESC, "Manual Command Setpoint")
  field(DTYP, "asynOctetWrite")
  field(OUT,  "@asyn($(PORT),0) MANUAL_CMD")
  field(VAL,"")
  field(PINI,"YES")
}

# --- PC Fault controls (F1..F4 on set) ---
record(bo, "$(P)CH1:PCFault-SP") {
    field(DESC, "Set/Reset CH1 PC Fault")
    field(ZNAM, "Reset")
    field(ONAM, "Set")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) PCFAULT1")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH2:PCFault-SP") {
    field(DESC, "Set/Reset CH2 PC Fault")
    field(ZNAM, "Reset")
    field(ONAM, "Set")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) PCFAULT2")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH3:PCFault-SP") {
    field(DESC, "Set/Reset CH3 PC Fault")
    field(ZNAM, "Reset")
    field(ONAM, "Set")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) PCFAULT3")
    field(VAL,"0")
    field(PINI,"YES")
}

record(bo, "$(P)CH4:PCFault-SP") {
    field(DESC, "Set/Reset CH4 PC Fault")
    field(ZNAM, "Reset")
    field(ONAM, "Set")
    field(DTYP,"asynInt32")
    field(OUT, "@asyn($(PORT),0) PCFAULT4")
    field(VAL,"0")
    field(PINI,"YES")
}

# =======================================
# Debug / last-sent command display
# =======================================

record(stringin, "$(P)Last:Cmd-I") {
  field(DESC, "Last non-D15? command")
  field(DTYP, "asynOctetRead")
  field(INP,  "@asyn($(PORT),0) LAST_CMD")
  field(SCAN, "I/O Intr")
  field(PINI,"YES")
  field(VAL,"N/A")

}

record(ai, "$(P)Last:CmdElapsed-I") {
  field(DESC, "Elapsed seconds since last command")
  field(DTYP, "asynFloat64")
  field(INP,  "@asyn($(PORT),0) LAST_CMD_ELAPSED")
  field(PREC, "3")
  field(SCAN, "I/O Intr")
  field(PINI, "YES")
}


